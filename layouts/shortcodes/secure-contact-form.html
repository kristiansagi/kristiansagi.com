{{- $origin  := .Get "origin"  | default "https://kristiansagi.com" -}}
{{- $subject := .Get "subject" | default "Encrypted message from kristiansagi.com/contact" -}}
{{- $title   := .Get "title"   | default "Send a secure message" -}}
{{- $id      := printf "pm-secure-form-%d" now.UnixNano -}}

<section id="{{ $id }}" class="pm-secure-form"
         data-origin="{{ $origin }}"
         data-subject="{{ $subject }}">
  <h2 class="pm-secure-title">{{ $title }}</h2>

  <div class="pm-field">
    <label for="{{ $id }}-from">From (name & contact)</label>
    <input id="{{ $id }}-from" type="text" autocomplete="off" spellcheck="false">
  </div>

  <div class="pm-field">
    <label for="{{ $id }}-msg">Message</label>
    <div id="{{ $id }}-msg" class="pm-editor" contenteditable role="textbox" aria-multiline="true"></div>
  </div>

  <div class="pm-actions">
    <button type="button" class="pm-btn pm-btn--neutral">Encrypt &amp; Send</button>
  </div>
</section>

<link rel="stylesheet" href="/css/secure-form.css">
<script src="/js/openpgp.min.js"></script>
<script>
(function attachSecureForm(id){
  const root = document.getElementById(id);
  if (!root) return;

  const ORIGIN        = root.dataset.origin;
  const SUBJECT       = root.dataset.subject;
  const PUBKEY_URL    = ORIGIN + '/kristian-sagi-pub.asc';
  const SEND_ENDPOINT = ORIGIN + '/api/send-encrypted';

  const fromEl  = root.querySelector('input[type="text"]');
  const msgEl   = root.querySelector('.pm-editor');
  const btn     = root.querySelector('.pm-btn');

  let pubKeyArmored = null;

  const fetchTxt = async (url) => {
    const r = await fetch(url, { cache: 'no-store', mode: 'cors' });
    if (!r.ok) throw new Error('HTTP ' + r.status + ' ' + url);
    return r.text();
  };

  async function loadPubKey(){
    if (pubKeyArmored) return pubKeyArmored;
    pubKeyArmored = await fetchTxt(PUBKEY_URL);
    return pubKeyArmored;
  }

  const getBody = () => (msgEl.innerText || '').replace(/\r/g,'').trim();

  async function encryptPlain(text){
    const armored = await loadPubKey();
    const key     = await openpgp.readKey({ armoredKey: armored });
    const message = await openpgp.createMessage({ text });
    return openpgp.encrypt({ message, encryptionKeys: key });
  }

  function clearForm(){
    fromEl.value = '';
    msgEl.innerHTML = '';
    pubKeyArmored = null;
  }

  async function onSend(e){
    e?.preventDefault?.();
    if (typeof window.openpgp === 'undefined') { alert('Encryption library missing.'); return; }

    const from = (fromEl.value || '').trim();
    const body = getBody();
    if (!from || !body) { alert('Please fill both fields.'); return; }

    try {
      btn.disabled = true;
      btn.textContent = 'Encrypting…';

      const composed = [
        `From: ${from}`,
        `Origin: ${location.origin}`,
        `Time: ${new Date().toISOString()}`,
        '---',
        body
      ].join('\n');

      const ciphertext = (await encryptPlain(composed)).trim();

      btn.textContent = 'Sending…';
      const res = await fetch(SEND_ENDPOINT, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ subject: SUBJECT, ciphertext })
      });
      if (!res.ok) throw new Error('Send failed (HTTP ' + res.status + ')');

      // success — clear and switch button to grey "Sent"
      clearForm();
      btn.classList.remove('pm-btn--neutral');
      btn.classList.add('pm-btn--sent');
      btn.textContent = 'Sent ✓';
      btn.disabled = true;

    } catch (err){
      btn.disabled = false;
      btn.textContent = 'Encrypt & Send';
      alert(err.message || String(err));
    }
  }

  btn.addEventListener('click', onSend);
})('{{ $id }}');
</script>
